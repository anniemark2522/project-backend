import db from "../../../config/firebase.js";
import fetch from "node-fetch";

export const createGym = async (req, res) => {
  try {
    const {
      name,
      url,
      description,
      openHours,
      location,
      image,
      province,
    } = req.body;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
    if (!name || !location || !province) {
      return res.status(400).json({ message: "Name, location, and province are required" });
    }

    // üî¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á gymId ‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏•‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö +1)
    const snapshot = await db.collection("detailGym").get();
    const ids = snapshot.docs
      .map((doc) => parseInt(doc.id))
      .filter((n) => !isNaN(n));
    const nextId = ids.length > 0 ? Math.max(...ids) + 1 : 1;
    const gymId = String(nextId);

    // üìù ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• detailGym
    const newGymData = {
      gymId,
      name,
      url: url || "",
      description: description || "",
      openHours: openHours || {},
      location,
      image: image || [],
      province: province || "",
    };

    // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á detailGym
    await db.collection("detailGym").doc(gymId).set(newGymData);

    // üåç ‡πÉ‡∏ä‡πâ Mapbox Geocoding ‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î
    const mapboxToken = process.env.MAPBOX_TOKEN;
    const fullAddress = `${name} ${province}`;
    const geoRes = await fetch(
      `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(
        fullAddress
      )}.json?access_token=${mapboxToken}`
    );
    const geoData = await geoRes.json();

    if (geoData?.features?.[0]) {
      const [lng, lat] = geoData.features[0].center;

      const gymLocationData = {
        gymId,
        name,
        location,
        province: province.toLowerCase(),
        lat: lat.toString(),
        long: lng.toString(),
        url: url || "",
      };

      // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á GymsLatLong ‡∏î‡πâ‡∏ß‡∏¢ gymId ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
      await db.collection("GymsLatLong").doc(gymId).set(gymLocationData);
    } else {
      console.warn("‚ö†Ô∏è Geocoding failed: Cannot find coordinates.");
    }

    return res.status(201).json({
      message: "Gym created successfully",
      gymId,
      data: newGymData,
    });
  } catch (error) {
    console.error("‚ùå Error creating gym:", error);
    return res.status(500).json({ error: "Internal Server Error" });
  }
};

// import db from "../../../config/firebase.js";

// export const createGym = async (req, res) => {
//   try {
//     const {
//       name,
//       url,
//       description,
//       openHours,
//       location,
//       image,
//       province,
//     } = req.body;

//     // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö field ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
//     if (!name || !location) {
//       return res.status(400).json({ message: "Name and location are required" });
//     }

//     // üî¢ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì gymId ‡πÉ‡∏´‡∏°‡πà (max + 1)
//     const snapshot = await db.collection("detailGym").get();
//     const ids = snapshot.docs
//       .map(doc => parseInt(doc.id))
//       .filter(n => !isNaN(n));
//     const nextId = ids.length > 0 ? Math.max(...ids) + 1 : 1;
//     const gymId = String(nextId);

//     // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
//     const newGymData = {
//       gymId,
//       name,
//       url: url || "",
//       description: description || "",
//       openHours: openHours || {},
//       location,
//       image: image || [],
//       province: province || "",
//     };

//     // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase
//     await db.collection("detailGym").doc(gymId).set(newGymData);

//     return res.status(201).json({
//       message: "Gym created successfully",
//       gymId,
//       data: newGymData,
//     });
//   } catch (error) {
//     console.error("‚ùå Error creating gym:", error);
//     return res.status(500).json({ error: "Internal Server Error" });
//   }
// };
